"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[4409],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>g});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,g=d["".concat(l,".").concat(m)]||d[m]||c[m]||i;return n?a.createElement(g,s(s({ref:t},p),{},{components:n})):a.createElement(g,s({ref:t},p))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[d]="string"==typeof e?e:r,s[1]=o;for(var u=2;u<i;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>s});var a=n(67294),r=n(86010);const i={tabItem:"tabItem_Ymn6"};function s(e){let{children:t,hidden:n,className:s}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(i.tabItem,s),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>N});var a=n(87462),r=n(67294),i=n(86010),s=n(12466),o=n(16550),l=n(91980),u=n(67392),p=n(50012);function d(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}function c(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??d(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function g(e){let{queryString:t=!1,groupId:n}=e;const a=(0,o.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(i),(0,r.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(a.location.search);t.set(i,e),a.replace({...a.location,search:t.toString()})}),[i,a])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,i=c(e),[s,o]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:i}))),[l,u]=g({queryString:n,groupId:a}),[d,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,i]=(0,p.Nk)(n);return[a,(0,r.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:a}),k=(()=>{const e=l??d;return m({value:e,tabValues:i})?e:null})();(0,r.useLayoutEffect)((()=>{k&&o(k)}),[k]);return{selectedValue:s,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),h(e)}),[u,h,i]),tabValues:i}}var k=n(72389);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function w(e){let{className:t,block:n,selectedValue:o,selectValue:l,tabValues:u}=e;const p=[],{blockElementScrollPositionUntilNextRender:d}=(0,s.o5)(),c=e=>{const t=e.currentTarget,n=p.indexOf(t),a=u[n].value;a!==o&&(d(t),l(a))},m=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=p.indexOf(e.currentTarget)+1;t=p[n]??p[0];break}case"ArrowLeft":{const n=p.indexOf(e.currentTarget)-1;t=p[n]??p[p.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:s}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:o===t?0:-1,"aria-selected":o===t,key:t,ref:e=>p.push(e),onKeyDown:m,onClick:c},s,{className:(0,i.Z)("tabs__item",f.tabItem,s?.className,{"tabs__item--active":o===t})}),n??t)})))}function b(e){let{lazy:t,children:n,selectedValue:a}=e;const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function y(e){const t=h(e);return r.createElement("div",{className:(0,i.Z)("tabs-container",f.tabList)},r.createElement(w,(0,a.Z)({},e,t)),r.createElement(b,(0,a.Z)({},e,t)))}function N(e){const t=(0,k.Z)();return r.createElement(y,(0,a.Z)({key:String(t)},e))}},46300:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),r=n(50012);function i(e){let{path:t}=e;const[n]=(0,r.Nk)("docusaurus.tab.js-ts"),i=t.lastIndexOf("{"),s=t.slice(i+1,t.length-1),[o,l]=s.split(","),u=t.slice(0,i);return a.createElement("code",null,u+("js"===n?o:l))}},24795:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>p,default:()=>k,frontMatter:()=>u,metadata:()=>d,toc:()=>m});var a=n(87462),r=(n(67294),n(3905)),i=n(46300),s=n(85162),o=n(74866),l=n(44996);const u={id:"06-auth",title:"Authentication"},p=void 0,d={unversionedId:"tutorials/todo-app/06-auth",id:"tutorials/todo-app/06-auth",title:"Authentication",description:"Most of the apps today require some sort of registration and login flows, and Wasp has support for it out of the box, so let's see how to add it to our Todo app!",source:"@site/docs/tutorials/todo-app/06-auth.md",sourceDirName:"tutorials/todo-app",slug:"/tutorials/todo-app/06-auth",permalink:"/docs/tutorials/todo-app/06-auth",draft:!1,editUrl:"https://github.com/wasp-lang/wasp/edit/release/web/docs/tutorials/todo-app/06-auth.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"06-auth",title:"Authentication"},sidebar:"docs",previous:{title:"Updating tasks",permalink:"/docs/tutorials/todo-app/05-updating-tasks"},next:{title:"Dependencies",permalink:"/docs/tutorials/todo-app/07-dependencies"}},c={},m=[{value:"Adding entity User",id:"adding-entity-user",level:2},{value:"Defining <code>app.auth</code>",id:"defining-appauth",level:2},{value:"Adding Login and Signup pages",id:"adding-login-and-signup-pages",level:2},{value:"Updating <code>MainPage</code> page to check if the user is authenticated",id:"updating-mainpage-page-to-check-if-the-user-is-authenticated",level:2},{value:"Defining User-Task relation in entities",id:"defining-user-task-relation-in-entities",level:2},{value:"Updating operations to forbid access to non-authenticated users",id:"updating-operations-to-forbid-access-to-non-authenticated-users",level:2},{value:"Logout button",id:"logout-button",level:2}],g={toc:m},h="wrapper";function k(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,a.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Most of the apps today require some sort of registration and login flows, and Wasp has support for it out of the box, so let's see how to add it to our Todo app!"),(0,r.kt)("p",null,"Let's define a Todo list (luckily we have an app for that now \ud83d\ude43) to get this done:"),(0,r.kt)("ul",{className:"contains-task-list"},(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add a new entity called ",(0,r.kt)("inlineCode",{parentName:"li"},"User"),"."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add ",(0,r.kt)("inlineCode",{parentName:"li"},"auth")," to our ",(0,r.kt)("inlineCode",{parentName:"li"},"app"),"."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add ",(0,r.kt)("inlineCode",{parentName:"li"},"Login")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"Signup")," pages."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Modify ",(0,r.kt)(i.Z,{path:"src/client/MainPage.{jsx,tsx}",mdxType:"FileExtSwitcher"})," so that it requires authentication."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add Prisma relation between ",(0,r.kt)("inlineCode",{parentName:"li"},"User")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"Task")," entities."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Modify our queries and actions so that they work only with the tasks belonging to the authenticated user."),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Add a logout button.")),(0,r.kt)("h2",{id:"adding-entity-user"},"Adding entity User"),(0,r.kt)("p",null,"First, let's define the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," entity:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},"// ...\n\nentity User {=psl\n    id          Int     @id @default(autoincrement())\n    username    String  @unique\n    password    String\npsl=}\n")),(0,r.kt)("p",null,"Run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp db migrate-dev\n")),(0,r.kt)("p",null,"to propagate the schema change (we added User)."),(0,r.kt)("h2",{id:"defining-appauth"},"Defining ",(0,r.kt)("inlineCode",{parentName:"h2"},"app.auth")),(0,r.kt)("p",null,"Next, we want to tell Wasp that we want full-stack ",(0,r.kt)("a",{parentName:"p",href:"/docs/language/features#authentication--authorization"},"authentication")," in our app, and that it should use the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," entity for it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'{7-16} title="main.wasp"',"{7-16}":!0,title:'"main.wasp"'},'app TodoApp {\n  wasp: {\n    version: "^0.7.0"\n  },\n  title: "Todo app",\n\n  auth: {\n    // Expects entity User to have username and passwords fields.\n    userEntity: User,\n    methods: {\n      // We also support Google, GitHub and email auth, with more on the way!\n      usernameAndPassword: {}\n    },\n    // We\'ll see how this is used a bit later\n    onAuthFailedRedirectTo: "/login"\n  }\n}\n')),(0,r.kt)("p",null,"What this means for us is that Wasp now offers us:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Login and Signup forms located at ",(0,r.kt)("inlineCode",{parentName:"li"},"@wasp/auth/forms/Login")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"@wasp/auth/forms/Signup")," paths, ready to be used."),(0,r.kt)("li",{parentName:"ul"},"a ",(0,r.kt)("inlineCode",{parentName:"li"},"logout()")," action."),(0,r.kt)("li",{parentName:"ul"},"a React hook ",(0,r.kt)("inlineCode",{parentName:"li"},"useAuth()"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"context.user")," as an argument within queries/actions.")),(0,r.kt)("p",null,"This is a very high-level API for auth which makes it very easy to get started quickly, but is\nnot very flexible. If you require more control (e.g. want to execute some custom code on the server\nduring signup, check out the ",(0,r.kt)("a",{parentName:"p",href:"/docs/language/features#lower-level-api"},"lower-level auth API"),"."),(0,r.kt)("p",null,"Ok, that was easy!"),(0,r.kt)("p",null,"To recap, so far we have defined:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"User")," entity."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"app.auth")," field, thanks to which Wasp gives us plenty of auth-related functionality.")),(0,r.kt)("h2",{id:"adding-login-and-signup-pages"},"Adding Login and Signup pages"),(0,r.kt)("p",null,"When we defined ",(0,r.kt)("inlineCode",{parentName:"p"},"app.auth")," we got login and signup forms generated for us, but now we have to create Login and Signup pages that use them. In our ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file we'll add the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'// ...\n\nroute SignupRoute { path: "/signup", to: SignupPage }\npage SignupPage {\n  component: import Signup from "@client/SignupPage"\n}\n\nroute LoginRoute { path: "/login", to: LoginPage }\npage LoginPage {\n  component: import Login from "@client/LoginPage"\n}\n')),(0,r.kt)("p",null,"Great, Wasp now knows how to route these and where to find the pages. Now to the React code of the pages:"),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/client/LoginPage.jsx"',title:'"src/client/LoginPage.jsx"'},"import { Link } from 'react-router-dom'\n\nimport { LoginForm } from '@wasp/auth/forms/Login'\n\nconst LoginPage = () => {\n  return (\n    <>\n      <LoginForm/>\n      <br/>\n      <span>\n        I don't have an account yet (<Link to=\"/signup\">go to signup</Link>).\n      </span>\n    </>\n  )\n}\n\nexport default LoginPage\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="src/client/LoginPage.tsx"',title:'"src/client/LoginPage.tsx"'},"import { Link } from 'react-router-dom'\n\nimport { LoginForm } from '@wasp/auth/forms/Login'\n\nconst LoginPage = () => {\n  return (\n    <>\n      <LoginForm/>\n      <br/>\n      <span>\n        I don't have an account yet (<Link to=\"/signup\">go to signup</Link>).\n      </span>\n    </>\n  )\n}\n\nexport default LoginPage\n")))),(0,r.kt)("p",null,"The Signup page is very similar to the login one:"),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/client/SignupPage.jsx"',title:'"src/client/SignupPage.jsx"'},"import { Link } from 'react-router-dom'\n\nimport { SignupForm } from '@wasp/auth/forms/Signup'\n\nconst SignupPage = () => {\n  return (\n    <>\n      <SignupForm/>\n      <br/>\n      <span>\n        I already have an account (<Link to=\"/login\">go to login</Link>).\n      </span>\n    </>\n  )\n}\n\nexport default SignupPage\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="src/client/SignupPage.tsx"',title:'"src/client/SignupPage.tsx"'},"import { Link } from 'react-router-dom'\n\nimport { SignupForm } from '@wasp/auth/forms/Signup'\n\nconst SignupPage = () => {\n  return (\n    <>\n      <SignupForm/>\n      <br/>\n      <span>\n        I already have an account (<Link to=\"/login\">go to login</Link>).\n      </span>\n    </>\n  )\n}\n\nexport default SignupPage\n")))),(0,r.kt)("h2",{id:"updating-mainpage-page-to-check-if-the-user-is-authenticated"},"Updating ",(0,r.kt)("inlineCode",{parentName:"h2"},"MainPage")," page to check if the user is authenticated"),(0,r.kt)("p",null,"Now, let's see how we're going to handle the situation when the user is not logged in.\n",(0,r.kt)("inlineCode",{parentName:"p"},"MainPage")," page is a private page and we want users to be able to see it only if they are authenticated.\nWasp allows you to simply enforce private pages using the ",(0,r.kt)("inlineCode",{parentName:"p"},"authRequired")," field:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'{3} title="main.wasp"',"{3}":!0,title:'"main.wasp"'},'// ...\npage MainPage {\n  authRequired: true,\n  component: import Main from "@client/MainPage"\n}\n')),(0,r.kt)("p",null,"With ",(0,r.kt)("inlineCode",{parentName:"p"},"authRequired: true")," we declared that page ",(0,r.kt)("inlineCode",{parentName:"p"},"MainPage")," is accessible only to authenticated users.\nIf an unauthenticated user tries to access route ",(0,r.kt)("inlineCode",{parentName:"p"},"/")," where our page ",(0,r.kt)("inlineCode",{parentName:"p"},"MainPage")," is, they will be redirected to ",(0,r.kt)("inlineCode",{parentName:"p"},"/login")," as specified with the ",(0,r.kt)("inlineCode",{parentName:"p"},"onAuthFailedRedirectTo")," property in ",(0,r.kt)("inlineCode",{parentName:"p"},"app.auth"),"."),(0,r.kt)("p",null,"Also, when ",(0,r.kt)("inlineCode",{parentName:"p"},"authRequired")," is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),", the React component of a page (specified by ",(0,r.kt)("inlineCode",{parentName:"p"},"component")," property within ",(0,r.kt)("inlineCode",{parentName:"p"},"page"),") will be provided ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," object as a prop. It can be accessed like this:"),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'{1} title="src/client/MainPage.jsx"',"{1}":!0,title:'"src/client/MainPage.jsx"'},"const MainPage = ({ user }) => {\n    // Do something with the user\n}\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'{3} title="src/client/MainPage.tsx"',"{3}":!0,title:'"src/client/MainPage.tsx"'},'import { User } from "@wasp/entities"\n\nconst MainPage = ({ user }: { user: User }) => {\n    // Do something with the user\n}\n')))),(0,r.kt)("p",null,"Ok, time to try out how this works!"),(0,r.kt)("p",null,"Now, we can start the app again (if it's not still running):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp start\n")),(0,r.kt)("p",null,"Try going to the main page (",(0,r.kt)("inlineCode",{parentName:"p"},"/"),") of our web app. It will now redirect you to ",(0,r.kt)("inlineCode",{parentName:"p"},"/login"),", where you'll be asked to authenticate. Once you log in or sign up, you will be sent back to ",(0,r.kt)("inlineCode",{parentName:"p"},"/")," and you will see the todo list."),(0,r.kt)("p",null,"Let's now see how things look in the database! Run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp db studio\n")),(0,r.kt)("img",{alt:"Database demonstration - password hashing",src:(0,l.Z)("img/wasp_db_hash_demonstration.gif"),style:{border:"1px solid black"}}),(0,r.kt)("p",null,"We see there is a user and that its password is already hashed! Wasp took care of this for us."),(0,r.kt)("p",null,"However, you will notice that if you try logging in with different users and creating tasks, all users are still sharing tasks.\nThat is because we did not yet update queries and actions to work only on the current user's tasks, so let's do that next!"),(0,r.kt)("h2",{id:"defining-user-task-relation-in-entities"},"Defining User-Task relation in entities"),(0,r.kt)("p",null,"First, let's define a one-to-many relation between User and Task (check the ",(0,r.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-schema/relations"},"prisma docs on relations"),"):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'{6,13-14} title="main.wasp"',"{6,13-14}":!0,title:'"main.wasp"'},"// ...\nentity User {=psl\n    id          Int     @id @default(autoincrement())\n    username    String  @unique\n    password    String\n    tasks       Task[]\npsl=}\n// ...\nentity Task {=psl\n    id          Int     @id @default(autoincrement())\n    description String\n    isDone      Boolean @default(false)\n    user        User?    @relation(fields: [userId], references: [id])\n    userId      Int?\npsl=}\n// ...\n")),(0,r.kt)("p",null,"We modified entities by adding the User-Task relation, so let's run"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp db migrate-dev\n")),(0,r.kt)("p",null,"to create a database schema migration and apply it to the database."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"We made ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"userId")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"Task")," optional (via ",(0,r.kt)("inlineCode",{parentName:"p"},"?"),") because that allows us to keep the existing tasks, which don't have a user assigned, in the database.\nThis is not recommended because it allows an unwanted state in the database (what is the purpose of the task not belonging to anybody?) and normally we would not make these fields optional.\nInstead, we would do a data migration to take care of those tasks, even if it means just deleting them all.\nHowever, for this tutorial, for the sake of simplicity, we will stick with this.")),(0,r.kt)("h2",{id:"updating-operations-to-forbid-access-to-non-authenticated-users"},"Updating operations to forbid access to non-authenticated users"),(0,r.kt)("p",null,"Next, let's update the queries and actions to forbid access to non-authenticated users and to operate only on the currently logged-in user's tasks:"),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'{1,4} title="src/server/queries.js"',"{1,4}":!0,title:'"src/server/queries.js"'},"import HttpError from '@wasp/core/HttpError.js'\n\nexport const getTasks = async (args, context) => {\n  if (!context.user) {\n    throw new HttpError(401)\n  }\n  return context.entities.Task.findMany(\n    { where: { user: { id: context.user.id } } }\n  )\n}\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'{3,6} title="src/server/queries.ts"',"{3,6}":!0,title:'"src/server/queries.ts"'},'import { Task }  from "@wasp/entities"\nimport { GetTasks } from "@wasp/queries/types"\nimport HttpError from \'@wasp/core/HttpError.js\'\n\nexport const getTasks: GetTasks<void, Task[]>  = async (args, context) => {\n  if (!context.user) {\n    throw new HttpError(401)\n  }\n  return context.entities.Task.findMany(\n    { where: { user: { id: context.user.id } } }\n  )\n}\n')))),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'{1,4,8,14,17,18} title="src/server/actions.js"',"{1,4,8,14,17,18}":!0,title:'"src/server/actions.js"'},"import HttpError from '@wasp/core/HttpError.js'\n\nexport const createTask = async (args, context) => {\n  if (!context.user) { throw new HttpError(401) }\n  return context.entities.Task.create({\n    data: {\n      description: args.description,\n      user: { connect: { id: context.user.id } }\n    }\n  })\n}\n\nexport const updateTask = async (args, context) => {\n  if (!context.user) {\n    throw new HttpError(401)\n  }\n  return context.entities.Task.updateMany({\n    where: { id: args.taskId, user: { id: context.user.id } },\n    data: { isDone: args.data.isDone }\n  })\n}\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'{3,11,17,28,31,32} title="src/server/actions.ts"',"{3,11,17,28,31,32}":!0,title:'"src/server/actions.ts"'},'import { Task } from "@wasp/entities"\nimport { CreateTask, UpdateTask } from "@wasp/actions/types"\nimport HttpError from \'@wasp/core/HttpError.js\'\n\ntype CreateTaskPayload = Pick<Task, "description">\n\nexport const createTask: CreateTask<CreateTaskPayload, Task> = async (\n  args,\n  context\n) => {\n  if (!context.user) {\n    throw new HttpError(401)\n  }\n  return context.entities.Task.create({\n    data: {\n      description: args.description,\n      user: { connect: { id: context.user.id } }\n    }\n  })\n}\n\ntype UpdateTaskPayload = Pick<Task, "id" | "isDone">\n\nexport const updateTask: UpdateTask<UpdateTaskPayload, { count: number }> = async (\n  { id, isDone },\n  context\n) => {\n  if (!context.user) {\n    throw new HttpError(401)\n  }\n  return context.entities.Task.updateMany({\n    where: { id: args.taskId, user: { id: context.user.id } },\n    data: { isDone: args.data.isDone }\n  })\n}\n')))),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Due to how Prisma works, we had to convert ",(0,r.kt)("inlineCode",{parentName:"p"},"update")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"updateMany")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"updateTask")," action to be able to specify the user id in ",(0,r.kt)("inlineCode",{parentName:"p"},"where"),".")),(0,r.kt)("p",null,"Right, that should be it!"),(0,r.kt)("p",null,"Run (or just continue running):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp start\n")),(0,r.kt)("p",null,"and everything should work as expected now! Each user has their own tasks only they can see and edit."),(0,r.kt)("p",null,"Try playing around with our app, adding a few users and some tasks. Then run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"wasp db studio\n")),(0,r.kt)("img",{alt:"Database demonstration",src:(0,l.Z)("img/wasp_db_demonstration.gif"),style:{border:"1px solid black"}}),(0,r.kt)("p",null,"You will see that each user has their own tasks, just as we specified in our code!"),(0,r.kt)("h2",{id:"logout-button"},"Logout button"),(0,r.kt)("p",null,"Last, but not least, let's add the logout functionality:"),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(s.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'{2,10} title="src/client/MainPage.jsx"',"{2,10}":!0,title:'"src/client/MainPage.jsx"'},"// ...\nimport logout from '@wasp/auth/logout'\n//...\n\nconst MainPage = () => {\n  // ...\n  return (\n    <div>\n      // ...\n      <button onClick={logout}>Logout</button>\n    </div>\n  )\n}\n"))),(0,r.kt)(s.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'{2,10} title="src/client/MainPage.tsx"',"{2,10}":!0,title:'"src/client/MainPage.tsx"'},"// ...\nimport logout from '@wasp/auth/logout'\n//...\n\nconst MainPage = () => {\n  // ...\n  return (\n    <div>\n      // ...\n      <button onClick={logout}>Logout</button>\n    </div>\n  )\n}\n")))),(0,r.kt)("p",null,"This is it, we have a working authentication system, and our Todo app is multi-user!"))}k.isMDXComponent=!0}}]);